<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Car Code Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        /* Custom scrollbar style for the list */
        .car-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .car-list-container::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
        }
        .car-list-container::-webkit-scrollbar-track {
            background: #161b22;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-[#58a6ff] mb-2">Community Car Code Submissions</h1>
            <p class="text-gray-400">Submit your finds! Data is stored in a cloud database and can be exported below.</p>
            <div id="user-info" class="mt-4 text-sm text-gray-500">
                <!-- User ID will be displayed here -->
            </div>
        </header>

        <!-- AI Lookup Section -->
        <div class="max-w-xl mx-auto bg-[#161b22] p-6 rounded-xl shadow-2xl border border-[#30363d] mb-10">
            <h2 class="text-2xl font-bold mb-4 text-white flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-yellow-400">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path>
                    <path d="M12 16v-4"></path>
                    <path d="M12 8h.01"></path>
                </svg>
                AI Car Code Suggestion
            </h2>
            <div id="ai-lookup-section">
                <label for="ai-image-url" class="block text-sm font-medium text-gray-400 mb-1">Paste Car Image URL (e.g., Garage Screenshot)</label>
                <div class="flex space-x-2">
                    <input type="url" id="ai-image-url" placeholder="https://doschdesign.com/images/image/Generic_02.jpg" class="flex-grow px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-yellow-400 focus:border-yellow-400 text-white">
                    <button type="button" id="generate-button" class="flex-shrink-0 py-2 px-4 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-200 flex items-center">
                        <span id="generate-text">Generate Info</span>
                        <span id="ai-loading-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full ml-2"></span>
                    </button>
                </div>
                <p id="ai-message-box" class="mt-3 text-sm font-medium"></p>
                <div id="ai-results" class="mt-4 p-3 bg-[#0d1117] border border-[#30363d] rounded-lg hidden">
                    <p class="text-yellow-400 font-semibold mb-2">AI Suggestions:</p>
                    <p class="text-gray-300 mb-1">Car Name: <span id="suggested-name" class="font-bold text-white"></span></p>
                    <p class="text-gray-300">Spawn Code: <span id="suggested-code" class="font-bold text-white"></span></p>
                    <button type="button" id="apply-suggestions" class="mt-3 w-full py-2 bg-[#58a6ff] text-white font-semibold rounded-lg hover:bg-[#79a9e3] transition duration-200">
                        Use These Suggestions
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Submission Form -->
        <div class="max-w-xl mx-auto bg-[#161b22] p-6 rounded-xl shadow-2xl border border-[#30363d] mb-10">
            <h2 class="text-2xl font-bold mb-4 text-white">Manual Car Submission</h2>
            <form id="submission-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Car Name -->
                    <div>
                        <label for="car-name" class="block text-sm font-medium text-gray-400 mb-1">Car Name (e.g., Supra MK4)</label>
                        <input type="text" id="car-name" required placeholder="Name" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                    </div>

                    <!-- Spawn Code -->
                    <div>
                        <label for="spawn-code" class="block text-sm font-medium text-gray-400 mb-1">Spawn Code (e.g., SPRA4)</label>
                        <input type="text" id="spawn-code" required placeholder="Code" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                    </div>
                </div>

                <!-- Image URL -->
                <div class="mt-4">
                    <label for="image-url" class="block text-sm font-medium text-gray-400 mb-1">Picture URL (Optional, for Manual Submission)</label>
                    <input type="url" id="image-url" placeholder="https://i.imgur.com/car.jpg" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                </div>

                <!-- Discord Name -->
                <div class="mt-4">
                    <label for="discord-name" class="block text-sm font-medium text-gray-400 mb-1">Your Discord Name (Mandatory)</label>
                    <input type="text" id="discord-name" required placeholder="YourName#1234" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                </div>

                <button type="submit" id="submit-button" class="w-full mt-6 py-3 px-4 bg-[#58a6ff] text-white font-semibold rounded-lg shadow-md hover:bg-[#79a9e3] transition duration-200">
                    <span id="button-text">Submit Car</span>
                    <span id="loading-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full mx-auto"></span>
                </button>
                <p id="message-box" class="mt-3 text-sm text-center font-medium"></p>
            </form>
        </div>

        <!-- Car List Display -->
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-white">Confirmed Car Submissions</h2>
                <button id="export-csv-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-200 shadow-md">
                    Export to CSV (for Sheets/Excel)
                </button>
            </div>
            <div id="car-list-loader" class="text-center p-8">
                 <div class="animate-spin h-8 w-8 border-4 border-[#58a6ff] border-t-transparent rounded-full mx-auto mb-3"></div>
                 Loading Data...
            </div>
            <div id="car-list" class="car-list-container bg-[#161b22] p-4 rounded-xl shadow-lg border border-[#30363d] max-h-[60vh] overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Car items will be rendered here -->
            </div>
            <p id="no-cars-message" class="hidden text-center text-gray-500 mt-4">No cars have been submitted yet. Be the first!</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, where, getDocs, arrayUnion, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- BEGIN CUSTOM FIREBASE CONFIGURATION ---
        // Use your actual Project ID for the appId variable
        const appId = 'car-data-b1d46'; 
        
        // Your specific Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKrGREVdOXkRiUByq4C3MGX1G9wcN7YcM",
            authDomain: "car-data-b1d46.firebaseapp.com",
            projectId: "car-data-b1d46",
            storageBucket: "car-data-b1d46.firebasestorage.app",
            messagingSenderId: "640847189726",
            appId: "1:640847189726:web:7b52539727a517e300944f"
        };
        
        // This token is only used in the Canvas environment, set to null for public deployment.
        const initialAuthToken = null; 
        // --- END CUSTOM FIREBASE CONFIGURATION ---

        let db, auth, userId, currentCarData = [];
        const apiKey = ""; // API Key for Gemini API, provided by Canvas environment

        // UI Elements (Form)
        const form = document.getElementById('submission-form');
        const carNameInput = document.getElementById('car-name');
        const spawnCodeInput = document.getElementById('spawn-code');
        const imageUrlInput = document.getElementById('image-url');
        const discordNameInput = document.getElementById('discord-name');
        const messageBox = document.getElementById('message-box');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // UI Elements (AI)
        const aiImageUrlInput = document.getElementById('ai-image-url');
        const generateButton = document.getElementById('generate-button');
        const generateText = document.getElementById('generate-text');
        const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
        const aiMessageBox = document.getElementById('ai-message-box');
        const aiResultsDiv = document.getElementById('ai-results');
        const suggestedNameSpan = document.getElementById('suggested-name');
        const suggestedCodeSpan = document.getElementById('suggested-code');
        const applySuggestionsButton = document.getElementById('apply-suggestions');

        // UI Elements (List)
        const carList = document.getElementById('car-list');
        const loader = document.getElementById('car-list-loader');
        const noCarsMessage = document.getElementById('no-cars-message');
        const userInfo = document.getElementById('user-info');
        const exportCsvButton = document.getElementById('export-csv-button');

        // Firestore Path Constants
        const PUBLIC_CARS_COLLECTION_PATH = `artifacts/${appId}/public/data/cars`;

        // Utility to display messages
        function showMessage(box, text, isError = false) {
            box.textContent = text;
            box.className = `mt-3 text-sm text-center font-medium ${isError ? 'text-red-400' : 'text-green-400'}`;
            setTimeout(() => {
                box.textContent = '';
            }, 5000);
        }
        
        function showFormMessage(text, isError = false) {
            showMessage(messageBox, text, isError);
        }
        
        function showAiMessage(text, isError = false) {
            showMessage(aiMessageBox, text, isError);
        }

        // Utility to toggle loading state for manual submit
        function toggleLoading(isLoading) {
            submitButton.disabled = isLoading;
            buttonText.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }

        // Utility to toggle loading state for AI lookup
        function toggleAiLoading(isLoading) {
            generateButton.disabled = isLoading;
            generateText.textContent = isLoading ? 'Analyzing...' : 'Generate Info';
            aiLoadingSpinner.classList.toggle('hidden', !isLoading);
        }
        
        // --- AI LOOKUP LOGIC ---

        // Function to fetch image data and convert to base64
        async function getBase64Image(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(\`Failed to fetch image: \${response.statusText}\`);

                const blob = await response.blob();
                
                // Get MIME type from the blob
                const mimeType = blob.type;
                if (!mimeType.startsWith('image/')) {
                     throw new Error('URL does not point to a valid image file.');
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // Extract base64 part (after "data:image/jpeg;base64,")
                        const base64Data = reader.result.split(',')[1];
                        resolve({ base64Data, mimeType });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Error fetching or converting image:", error);
                throw new Error("Could not load or process the image from the URL provided. Please check the URL.");
            }
        }

        // Main AI Generation function
        async function generateCarInfo() {
            aiResultsDiv.classList.add('hidden');
            const imageUrl = aiImageUrlInput.value.trim();

            if (!imageUrl) {
                showAiMessage("Please paste an image URL first.", true);
                return;
            }

            toggleAiLoading(true);
            showAiMessage("Analyzing image, please wait...", false);

            try {
                // 1. Get Base64 data from the URL
                const { base64Data, mimeType } = await getBase64Image(imageUrl);

                // 2. Define the system instruction and user prompt
                const systemPrompt = \`You are an expert vehicle identification assistant. Analyze the image and extract the Car Name (model name) and its corresponding 5-letter Spawn Code used in the game FiveM/GTA V roleplaying servers. Your output MUST be in a strict JSON format.\`;
                const userQuery = \`Analyze this image of a car. Identify the Car Name (e.g., Sultan RS) and its 5-letter Spawn Code (e.g., SULTN). If you cannot confidently identify the code, provide a best guess or leave the spawnCode blank. Respond only with the JSON object.\`;

                // 3. Construct the API payload for structured response
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "carName": { "type": "STRING", "description": "The full vehicle name or model." },
                                "spawnCode": { "type": "STRING", "description": "The 5-letter spawn code for the car." }
                            },
                            required: ["carName", "spawnCode"]
                        }
                    }
                };

                const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=\${apiKey}\`;

                // 4. Make the API call (with exponential backoff handled by the environment)
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                let generatedData = null;
                
                // 5. Extract and parse the JSON response
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const jsonString = result.candidates[0].content.parts[0].text;
                    generatedData = JSON.parse(jsonString);
                    
                } else {
                    throw new Error("AI response was empty or malformed.");
                }

                if (generatedData && generatedData.carName && generatedData.spawnCode) {
                    // Display the suggestions
                    suggestedNameSpan.textContent = generatedData.carName;
                    suggestedCodeSpan.textContent = generatedData.spawnCode;
                    aiResultsDiv.classList.remove('hidden');
                    showAiMessage("Analysis complete! Review the suggestions below.", false);

                    // Store the image URL to be applied later
                    aiResultsDiv.dataset.imageUrl = imageUrl; 
                    
                } else {
                    throw new Error("AI could not confidently identify the car name or spawn code.");
                }

            } catch (error) {
                console.error("AI Lookup failed:", error);
                showAiMessage(\`AI Lookup failed: \${error.message}\`, true);
            } finally {
                toggleAiLoading(false);
            }
        }
        
        // Event Listeners for AI section
        generateButton.addEventListener('click', generateCarInfo);
        applySuggestionsButton.addEventListener('click', () => {
            const suggestedName = suggestedNameSpan.textContent;
            const suggestedCode = suggestedCodeSpan.textContent;
            const aiImageUrl = aiResultsDiv.dataset.imageUrl || aiImageUrlInput.value.trim();

            if (suggestedName && suggestedCode) {
                // Fill the manual submission fields
                carNameInput.value = suggestedName;
                spawnCodeInput.value = suggestedCode;
                imageUrlInput.value = aiImageUrl; // Apply the image URL to the manual submission form
                
                showFormMessage("Suggestions applied to the submission form! Please check the details and add your Discord Name.", false);
                // Clear AI results section after applying
                aiResultsDiv.classList.add('hidden');
            }
        });


        // --- FIREBASE INITIALIZATION AND CRUD (Unchanged from previous version) ---
        
        // --- 1. INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment for Firestore debugging
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await setPersistence(auth, browserSessionPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfo.textContent = `Current User ID: ${userId} (used for tracking submissions)`;
                        startRealtimeListener();
                    } else {
                        userId = null;
                        userInfo.textContent = `Authentication required to submit/view data.`;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showFormMessage(`Initialization error: ${error.message}`, true);
            }
        }

        // --- 2. DATA SUBMISSION LOGIC ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                showFormMessage("Database connection not ready. Please wait.", true);
                return;
            }

            // Get raw input values
            const rawCarName = carNameInput.value;
            const rawSpawnCode = spawnCodeInput.value;
            const imageUrl = imageUrlInput.value.trim();
            const rawDiscordName = discordNameInput.value;

            // Normalize and validate inputs
            const carName = rawCarName.trim();
            const spawnCode = rawSpawnCode.trim();
            const discordName = rawDiscordName.trim();
            
            if (!carName || !spawnCode || !discordName) {
                showFormMessage("Car Name, Spawn Code, and Discord Name are required.", true);
                return;
            }

            // Standardize the fields used for searching and saving to lowercase for case-insensitivity
            const searchName = carName.toLowerCase();
            const searchCode = spawnCode.toLowerCase();

            toggleLoading(true);

            try {
                const carsRef = collection(db, PUBLIC_CARS_COLLECTION_PATH);

                let existingCarDoc = null;
                let carDocRef = null;

                // Priority 1: Search by standardized name
                const qByName = query(carsRef, where('name', '==', searchName));
                const snapshotByName = await getDocs(qByName);

                if (!snapshotByName.empty) {
                    existingCarDoc = snapshotByName.docs[0];
                    carDocRef = doc(db, PUBLIC_CARS_COLLECTION_PATH, existingCarDoc.id);
                } else {
                    // Priority 2: Search by standardized code
                    const qByCode = query(carsRef, where('code', '==', searchCode));
                    const snapshotByCode = await getDocs(qByCode);
                    if (!snapshotByCode.empty) {
                        existingCarDoc = snapshotByCode.docs[0];
                        carDocRef = doc(db, PUBLIC_CARS_COLLECTION_PATH, existingCarDoc.id);
                    }
                }

                // CRITICAL FIX: Use client-side timestamp (Date.now()) inside the array
                const newSubmission = {
                    userId: userId,
                    discordName: discordName,
                    timestamp: Date.now() 
                };

                if (existingCarDoc) {
                    // 2. If Car Exists (Update)
                    const existingData = existingCarDoc.data();

                    // Prevent duplicate submissions by the same user with the same discord tag
                    const alreadySubmitted = existingData.submissions.some(s => s.userId === userId && s.discordName === discordName);

                    if (alreadySubmitted) {
                        showFormMessage(`You (User ID: ${userId}) have already submitted this car under Discord name '${discordName}'. Count not updated.`, false);
                        toggleLoading(false);
                        return;
                    }

                    await updateDoc(carDocRef, {
                        count: existingData.count + 1,
                        submissions: arrayUnion(newSubmission),
                        imageUrl: existingData.imageUrl || imageUrl,
                        updatedAt: serverTimestamp() 
                    });

                    showFormMessage(`Car '${carName}' already exists. Submission count updated to x${existingData.count + 1}!`, false);

                } else {
                    // 3. If Car is New (Create)
                    const newCarData = {
                        name: searchName,
                        code: searchCode,
                        imageUrl: imageUrl,
                        count: 1,
                        submissions: [newSubmission], 
                        createdAt: serverTimestamp(), 
                        updatedAt: serverTimestamp() 
                    };

                    await addDoc(carsRef, newCarData);
                    showFormMessage(`New car '${carName}' submitted successfully!`, false);
                }

                // Clear form fields
                form.reset();
                aiImageUrlInput.value = ''; // Also clear the AI lookup image URL

            } catch (error) {
                console.error("Error submitting car:", error);
                showFormMessage(`Failed to submit car: ${error.message}`, true);
            } finally {
                toggleLoading(false);
            }
        });


        // --- 3. REAL-TIME DATA LISTENER AND RENDERING ---

        function renderCarList(cars) {
            currentCarData = cars; 
            carList.innerHTML = '';
            loader.classList.add('hidden');

            if (cars.length === 0) {
                noCarsMessage.classList.remove('hidden');
                return;
            }

            noCarsMessage.classList.add('hidden');

            // Sort by count (descending)
            cars.sort((a, b) => b.count - a.count);

            cars.forEach(car => {
                const submitters = car.submissions
                    .map(s => `<span class="bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded-full text-xs">${s.discordName}</span>`)
                    .join(' ');

                const cardHtml = `
                    <div class="flex flex-col sm:flex-row bg-[#0d1117] p-4 rounded-xl shadow-xl border border-[#30363d] space-y-3 sm:space-y-0 sm:space-x-4">
                        <!-- Left: Image and Count -->
                        <div class="flex-shrink-0 relative w-full sm:w-28 h-28 rounded-lg overflow-hidden border border-[#30363d]">
                            <img src="${car.imageUrl || 'https://placehold.co/112x112/161b22/c9d1d9?text=NO+PIC'}"
                                 alt="${car.name}"
                                 class="w-full h-full object-cover"
                                 onerror="this.onerror=null; this.src='https://placehold.co/112x112/161b22/c9d1d9?text=NO+PIC';"
                            >
                            <span class="absolute top-0 right-0 bg-red-600 text-white font-bold text-lg px-2 py-1 rounded-bl-lg">
                                x${car.count}
                            </span>
                        </div>

                        <!-- Right: Details -->
                        <div class="flex-grow">
                            <!-- Display the name exactly as saved (lowercase) -->
                            <h3 class="text-xl font-bold text-white mb-1">${car.name.toUpperCase()}</h3>
                            <p class="text-gray-400 mb-2">Code: <span class="font-mono text-[#58a6ff]">${car.code.toUpperCase()}</span></p>

                            <div class="mt-2">
                                <p class="text-xs font-semibold text-gray-400 mb-1">Submitted By:</p>
                                <div class="flex flex-wrap gap-2 max-h-12 overflow-y-auto">
                                    ${submitters}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                carList.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        function startRealtimeListener() {
            const q = collection(db, PUBLIC_CARS_COLLECTION_PATH);

            onSnapshot(q, (snapshot) => {
                const cars = [];
                snapshot.forEach((doc) => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                renderCarList(cars);
            }, (error) => {
                console.error("Error fetching real-time data: ", error);
                loader.classList.add('hidden');
                showFormMessage("Failed to load car list in real-time.", true);
            });
        }
        
        // --- 4. EXPORT TO CSV LOGIC ---
        function exportToCsv() {
            if (!currentCarData || currentCarData.length === 0) {
                showFormMessage("No data to export yet!", true);
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Car Name,Spawn Code,Count,Submissions (Discord Names)\n";

            currentCarData.forEach(car => {
                const discordNames = car.submissions.map(s => s.discordName).join("; ");
                const safeName = car.name.replace(/"/g, '""');
                const safeCode = car.code.replace(/"/g, '""');
                
                csvContent += `"${safeName}","${safeCode}",${car.count},"${discordNames}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "car_spawn_codes_export.csv");
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
        }
        
        exportCsvButton.addEventListener('click', exportToCsv);

        // Initialize the application when the window loads
        window.onload = initializeFirebase;

    </script>
</body>
</html>
