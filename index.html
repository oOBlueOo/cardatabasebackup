<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Car Code Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        /* Custom scrollbar style for the list */
        .car-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .car-list-container::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
        }
        .car-list-container::-webkit-scrollbar-track {
            background: #161b22;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-[#58a6ff] mb-2">Community Car Code Submissions</h1>
            <p class="text-gray-400">Submit your finds! Data is stored in a cloud database and can be exported below.</p>
            <div id="user-info" class="mt-4 text-sm text-gray-500">
                <!-- User ID will be displayed here -->
            </div>
        </header>

        <!-- Submission Form -->
        <div class="max-w-xl mx-auto bg-[#161b22] p-6 rounded-xl shadow-2xl border border-[#30363d] mb-10">
            <h2 class="text-2xl font-bold mb-4 text-white">Submit a New Car</h2>
            <form id="submission-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Car Name -->
                    <div>
                        <label for="car-name" class="block text-sm font-medium text-gray-400 mb-1">Car Name (e.g., Supra MK4)</label>
                        <input type="text" id="car-name" required placeholder="Name" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                    </div>

                    <!-- Spawn Code -->
                    <div>
                        <label for="spawn-code" class="block text-sm font-medium text-gray-400 mb-1">Spawn Code (e.g., SPRA4)</label>
                        <input type="text" id="spawn-code" required placeholder="Code" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                    </div>
                </div>

                <!-- Image URL -->
                <div class="mt-4">
                    <label for="image-url" class="block text-sm font-medium text-gray-400 mb-1">Picture URL (Optional)</label>
                    <input type="url" id="image-url" placeholder="https://i.imgur.com/car.jpg" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                </div>

                <!-- Discord Name -->
                <div class="mt-4">
                    <label for="discord-name" class="block text-sm font-medium text-gray-400 mb-1">Your Discord Name (Mandatory)</label>
                    <input type="text" id="discord-name" required placeholder="YourName#1234" class="w-full px-4 py-2 bg-[#0d1117] border border-[#30363d] rounded-lg focus:ring-[#58a6ff] focus:border-[#58a6ff] text-white">
                </div>

                <button type="submit" id="submit-button" class="w-full mt-6 py-3 px-4 bg-[#58a6ff] text-white font-semibold rounded-lg shadow-md hover:bg-[#79a9e3] transition duration-200">
                    <span id="button-text">Submit Car</span>
                    <span id="loading-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full mx-auto"></span>
                </button>
                <p id="message-box" class="mt-3 text-sm text-center font-medium"></p>
            </form>
        </div>

        <!-- Car List Display -->
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-white">Confirmed Car Submissions</h2>
                <button id="export-csv-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-200 shadow-md">
                    Export to CSV (for Sheets/Excel)
                </button>
            </div>
            <div id="car-list-loader" class="text-center p-8">
                 <div class="animate-spin h-8 w-8 border-4 border-[#58a6ff] border-t-transparent rounded-full mx-auto mb-3"></div>
                 Loading Data...
            </div>
            <div id="car-list" class="car-list-container bg-[#161b22] p-4 rounded-xl shadow-lg border border-[#30363d] max-h-[60vh] overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Car items will be rendered here -->
            </div>
            <p id="no-cars-message" class="hidden text-center text-gray-500 mt-4">No cars have been submitted yet. Be the first!</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, where, getDocs, arrayUnion, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- BEGIN CUSTOM FIREBASE CONFIGURATION ---
        // Use your actual Project ID for the appId variable
        const appId = 'car-data-b1d46'; 
        
        // Your specific Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKrGREVdOXkRiUByq4C3MGX1G9wcN7YcM",
            authDomain: "car-data-b1d46.firebaseapp.com",
            projectId: "car-data-b1d46",
            storageBucket: "car-data-b1d46.firebasestorage.app",
            messagingSenderId: "640847189726",
            appId: "1:640847189726:web:7b52539727a517e300944f"
        };
        
        // This token is only used in the Canvas environment, set to null for public deployment.
        const initialAuthToken = null; 
        // --- END CUSTOM FIREBASE CONFIGURATION ---

        let db, auth, userId, currentCarData = [];

        // UI Elements
        const form = document.getElementById('submission-form');
        const carList = document.getElementById('car-list');
        const loader = document.getElementById('car-list-loader');
        const noCarsMessage = document.getElementById('no-cars-message');
        const messageBox = document.getElementById('message-box');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userInfo = document.getElementById('user-info');
        const exportCsvButton = document.getElementById('export-csv-button');

        // Firestore Path Constants
        const PUBLIC_CARS_COLLECTION_PATH = `artifacts/${appId}/public/data/cars`;

        // Utility to display messages
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = `mt-3 text-sm text-center font-medium ${isError ? 'text-red-400' : 'text-green-400'}`;
            setTimeout(() => {
                messageBox.textContent = '';
            }, 5000);
        }

        // Utility to toggle loading state
        function toggleLoading(isLoading) {
            submitButton.disabled = isLoading;
            buttonText.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }

        // --- 1. INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                // Set Firestore log level for debugging
                // setLogLevel('debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Ensure session persistence is set (optional, but good practice)
                await setPersistence(auth, browserSessionPersistence);

                // Sign in using the custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sign in anonymously for public read/write access (as defined in the security rules)
                    await signInAnonymously(auth);
                }

                // Listen for Auth state changes to set userId and start data sync
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // userId is the unique identifier used by the app for tracking submissions
                        userId = user.uid;
                        userInfo.textContent = `Current User ID: ${userId} (used for tracking submissions)`;
                        startRealtimeListener();
                    } else {
                        userId = null;
                        userInfo.textContent = `Authentication required to submit/view data.`;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showMessage(`Initialization error: ${error.message}`, true);
            }
        }

        // --- 2. DATA SUBMISSION LOGIC ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                showMessage("Database connection not ready. Please wait.", true);
                return;
            }

            // Get raw input values
            const rawCarName = document.getElementById('car-name').value;
            const rawSpawnCode = document.getElementById('spawn-code').value;
            const imageUrl = document.getElementById('image-url').value.trim();
            const rawDiscordName = document.getElementById('discord-name').value;

            // Normalize and validate inputs
            const carName = rawCarName.trim();
            const spawnCode = rawSpawnCode.trim();
            const discordName = rawDiscordName.trim();
            
            if (!carName || !spawnCode || !discordName) {
                showMessage("Car Name, Spawn Code, and Discord Name are required.", true);
                return;
            }

            // Standardize the fields used for searching and saving to lowercase for case-insensitivity
            const searchName = carName.toLowerCase();
            const searchCode = spawnCode.toLowerCase();

            toggleLoading(true);

            try {
                // 1. Check if the car already exists by standardized name or code
                const carsRef = collection(db, PUBLIC_CARS_COLLECTION_PATH);

                let existingCarDoc = null;
                let carDocRef = null;

                // Priority 1: Search by standardized name
                const qByName = query(carsRef, where('name', '==', searchName));
                const snapshotByName = await getDocs(qByName);

                if (!snapshotByName.empty) {
                    // Found by name
                    existingCarDoc = snapshotByName.docs[0];
                    carDocRef = doc(db, PUBLIC_CARS_COLLECTION_PATH, existingCarDoc.id);
                } else {
                    // Priority 2: Search by standardized code
                    const qByCode = query(carsRef, where('code', '==', searchCode));
                    const snapshotByCode = await getDocs(qByCode);
                    if (!snapshotByCode.empty) {
                        existingCarDoc = snapshotByCode.docs[0];
                        carDocRef = doc(db, PUBLIC_CARS_COLLECTION_PATH, existingCarDoc.id);
                    }
                }

                // --- CRITICAL FIX: Use client-side timestamp (Date.now()) inside the array ---
                const newSubmission = {
                    userId: userId,
                    discordName: discordName,
                    timestamp: Date.now() 
                };

                if (existingCarDoc) {
                    // 2. If Car Exists (Update)
                    const existingData = existingCarDoc.data();

                    // Prevent duplicate submissions by the same user with the same discord tag
                    const alreadySubmitted = existingData.submissions.some(s => s.userId === userId && s.discordName === discordName);

                    if (alreadySubmitted) {
                        showMessage(`You (User ID: ${userId}) have already submitted this car under Discord name '${discordName}'. Count not updated.`, false);
                        toggleLoading(false);
                        return;
                    }

                    await updateDoc(carDocRef, {
                        count: existingData.count + 1,
                        submissions: arrayUnion(newSubmission),
                        // Only update the image if the existing one is missing and a new one is provided
                        imageUrl: existingData.imageUrl || imageUrl,
                        updatedAt: serverTimestamp() // Use serverTimestamp for the top-level field
                    });

                    showMessage(`Car '${carName}' already exists. Submission count updated to x${existingData.count + 1}!`, false);

                } else {
                    // 3. If Car is New (Create)
                    const newCarData = {
                        // Save standardized (lowercase) versions for future searches
                        name: searchName,
                        code: searchCode,
                        imageUrl: imageUrl,
                        count: 1,
                        // The submissions array now correctly uses Date.now()
                        submissions: [newSubmission], 
                        createdAt: serverTimestamp(), // Use serverTimestamp for the top-level field
                        updatedAt: serverTimestamp() // Use serverTimestamp for the top-level field
                    };

                    await addDoc(carsRef, newCarData);
                    showMessage(`New car '${carName}' submitted successfully!`, false);
                }

                // Clear form fields
                form.reset();

            } catch (error) {
                console.error("Error submitting car:", error);
                showMessage(`Failed to submit car: ${error.message}`, true);
            } finally {
                toggleLoading(false);
            }
        });


        // --- 3. REAL-TIME DATA LISTENER AND RENDERING ---

        function renderCarList(cars) {
            currentCarData = cars; // Store the latest data globally for export
            carList.innerHTML = '';
            loader.classList.add('hidden');

            if (cars.length === 0) {
                noCarsMessage.classList.remove('hidden');
                return;
            }

            noCarsMessage.classList.add('hidden');

            // Sort by count (descending)
            cars.sort((a, b) => b.count - a.count);

            cars.forEach(car => {
                const submitters = car.submissions
                    .map(s => `<span class="bg-blue-900/50 text-blue-300 px-2 py-0.5 rounded-full text-xs">${s.discordName}</span>`)
                    .join(' ');

                const cardHtml = `
                    <div class="flex flex-col sm:flex-row bg-[#0d1117] p-4 rounded-xl shadow-xl border border-[#30363d] space-y-3 sm:space-y-0 sm:space-x-4">
                        <!-- Left: Image and Count -->
                        <div class="flex-shrink-0 relative w-full sm:w-28 h-28 rounded-lg overflow-hidden border border-[#30363d]">
                            <img src="${car.imageUrl || 'https://placehold.co/112x112/161b22/c9d1d9?text=NO+PIC'}"
                                 alt="${car.name}"
                                 class="w-full h-full object-cover"
                                 onerror="this.onerror=null; this.src='https://placehold.co/112x112/161b22/c9d1d9?text=NO+PIC';"
                            >
                            <span class="absolute top-0 right-0 bg-red-600 text-white font-bold text-lg px-2 py-1 rounded-bl-lg">
                                x${car.count}
                            </span>
                        </div>

                        <!-- Right: Details -->
                        <div class="flex-grow">
                            <!-- Display the name exactly as saved (lowercase) -->
                            <h3 class="text-xl font-bold text-white mb-1">${car.name.toUpperCase()}</h3>
                            <p class="text-gray-400 mb-2">Code: <span class="font-mono text-[#58a6ff]">${car.code.toUpperCase()}</span></p>

                            <div class="mt-2">
                                <p class="text-xs font-semibold text-gray-400 mb-1">Submitted By:</p>
                                <div class="flex flex-wrap gap-2 max-h-12 overflow-y-auto">
                                    ${submitters}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                carList.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        function startRealtimeListener() {
            const q = collection(db, PUBLIC_CARS_COLLECTION_PATH);

            // Set up the real-time listener
            onSnapshot(q, (snapshot) => {
                const cars = [];
                snapshot.forEach((doc) => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                renderCarList(cars);
            }, (error) => {
                console.error("Error fetching real-time data: ", error);
                loader.classList.add('hidden');
                showMessage("Failed to load car list in real-time.", true);
            });
        }
        
        // --- 4. EXPORT TO CSV LOGIC ---
        function exportToCsv() {
            if (!currentCarData || currentCarData.length === 0) {
                showMessage("No data to export yet!", true);
                return;
            }

            // CSV Header
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Car Name,Spawn Code,Count,Submissions (Discord Names)\n";

            // CSV Rows
            currentCarData.forEach(car => {
                const discordNames = car.submissions.map(s => s.discordName).join("; "); // Separated by semicolon within the CSV cell
                // Escape quotes in data to prevent CSV breakage
                const safeName = car.name.replace(/"/g, '""');
                const safeCode = car.code.replace(/"/g, '""');
                
                csvContent += `"${safeName}","${safeCode}",${car.count},"${discordNames}"\n`;
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "car_spawn_codes_export.csv");
            document.body.appendChild(link); // Required for FF
            
            link.click();
            document.body.removeChild(link);
        }
        
        exportCsvButton.addEventListener('click', exportToCsv);

        // Initialize the application when the window loads
        window.onload = initializeFirebase;

    </script>
</body>
</html>
